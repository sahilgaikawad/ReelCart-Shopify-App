{% comment %}
  ReelCart Pro ‚Äì Final Storefront Widget
  Updates: Dynamic Likes & Views from Database (Real + Boost)
{% endcomment %}

<div class="reelcart-main-container" id="rc-main-container">
  <div class="reel-header-area">
    <h2 class="reel-title-text" id="rc-widget-heading">{{ section.settings.heading | default: 'Shop the Look' }}</h2>
    <div class="reel-navigation" id="reel-nav-controls">
      <button class="reel-nav-btn" onclick="scrollReelList(-1)">&#10094;</button>
      <button class="reel-nav-btn" onclick="scrollReelList(1)">&#10095;</button>
    </div>
  </div>

  <div id="reel-app-container" class="reel-pro-scroller">
    </div>
</div>

<script>
  let isRequestPending = false;

  const icons = {
      heartOutline: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="18"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.72-8.72a5.5 5.5 0 0 0 0-7.78z"/></svg>`,
      heartFilled: `<svg viewBox="0 0 24 24" fill="#ff4d4d" width="18"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.72-8.72a5.5 5.5 0 0 0 0-7.78z"/></svg>`,
      bag: `<svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M6 2L3 6v14a2 2 0 002 2h12a2 2 0 002-2V6l-3-4H6zM12 11a3 3 0 110-6 3 3 0 010 6z"/></svg>`,
      mute: `<svg viewBox="0 0 24 24" fill="white" width="18"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77zM4.27 3L3 4.27l4.73 4.73H3v6h4l5 5V13.73l4.73 4.73c-.45.34-.94.63-1.46.87v2.04c1.09-.28 2.09-.8 2.95-1.48L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09l2.09 2.09V4z"/></svg>`,
      unmute: `<svg viewBox="0 0 24 24" fill="white" width="18"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`
  };

  async function loadStoreReels() {
    const container = document.getElementById('reel-app-container');
    const mainWrapper = document.getElementById('rc-main-container');
    const headingEl = document.getElementById('rc-widget-heading');

    try {
      const res = await fetch('/apps/reel-data?shop={{ shop.permanent_domain }}&v=' + Date.now());
      const data = await res.json();
      const reels = (data.reels || []).filter(r => r.videoUrl && r.productHandle);
      
      const s = {
        primaryColor: '#000000',
        buttonTextColor: '#ffffff',
        buttonText: 'Add to Bag',
        widgetBackgroundColor: 'transparent',
        cardBackgroundColor: '#ffffff',
        widgetHeadingColor: '#000000',
        productTitleColor: '#333333',
        productPriceColor: '#666666',
        productTextSize: 14,
        widgetGap: 16,
        cardWidth: 250, 
        sectionPadding: 20, 
        sectionRadius: 0,   
        widgetLayout: 'slider',
        widgetAspectRatio: '9:16',
        widgetCornerRadius: 12,
        buttonAnimation: 'none',
        showProductDetails: true,
        showViews: true, // Should match admin settings
        showRating: true,
        ...(data.settings || {})
      };

      if (reels.length === 0) {
        container.style.display = 'none';
        return;
      }

      // --- STYLING ---
      if(s.widgetBackgroundColor !== 'transparent') {
          mainWrapper.style.backgroundColor = s.widgetBackgroundColor;
      }
      mainWrapper.style.padding = `${s.sectionPadding}px`;
      mainWrapper.style.borderRadius = `${s.sectionRadius}px`;
      
      headingEl.style.color = s.widgetHeadingColor;
      if (s.widgetHeading) headingEl.innerText = s.widgetHeading;

      // üî• Dynamic Variables
      container.style.setProperty('--rc-card-width', `${s.cardWidth}px`);
      
      // Scale Factor: Shrinks text if card is smaller than 250px
      const scaleFactor = Math.max(0.7, Math.min(s.cardWidth / 250, 1.3));
      container.style.setProperty('--rc-text-scale', scaleFactor);
      
      // Badge Size Logic
      const badgeFontSize = Math.max(9, s.cardWidth * 0.04);
      container.style.setProperty('--rc-badge-font-size', `${badgeFontSize}px`);

      container.style.gap = `${s.widgetGap}px`;

      // Layout
      if (s.widgetLayout === 'grid') {
        container.classList.add('grid-mode');
        container.style.gridTemplateColumns = `repeat(auto-fill, minmax(${s.cardWidth}px, 1fr))`;
        document.getElementById('reel-nav-controls').style.display = 'none';
      } else {
        container.classList.remove('grid-mode');
        document.getElementById('reel-nav-controls').style.display = 'flex';
      }

      container.innerHTML = reels.map(r => {
        const priceValue = r.price ? parseFloat(r.price.toString().replace(/[^0-9.]/g, '')) : 0;
        const compareValue = r.comparePrice ? parseFloat(r.comparePrice.toString().replace(/[^0-9.]/g, '')) : 0;
        
        // Discount Calculation
        let discount = 0;
        if (compareValue > priceValue && compareValue > 0) {
            discount = Math.round(((compareValue - priceValue) / compareValue) * 100);
        }
        
        // üî• DYNAMIC VIEWS: Real + Boost
        const totalViews = (r.views || 0) + (r.boostViews || 0);

        const arClass = s.widgetAspectRatio === '1:1' ? 'aspect-square' : 'aspect-portrait';
        
        return `
          <div class="reel-exact-card" 
               style="border-radius: ${s.widgetCornerRadius}px;"
               onmouseenter="handleHoverPlay('video-${r.id}', true)"
               onmouseleave="handleHoverPlay('video-${r.id}', false)">
            
            <div class="video-container-box ${arClass}">
                <video id="video-${r.id}" class="reel-video-element" muted loop playsinline autoplay poster="${r.productImage || ''}" onplay="trackView('${r.id}')">
                  <source src="${r.videoUrl}" type="video/mp4">
                </video>
                <div class="reel-gradient-overlay"></div>

                <div class="reel-ui-layer">
                  <div class="top-stats-row">
                    ${s.showViews ? `<span class="stat-pill">üëÅÔ∏è ${totalViews}</span>` : ''}
                    ${s.showRating ? `<span class="stat-pill">‚≠ê ${r.rating || '4.8'}</span>` : ''}
                  </div>
                  
                  <div class="mute-btn-overlay" id="mute-btn-${r.id}" onclick="toggleMute('${r.id}')">${icons.mute}</div>
                  
                  <button class="view-tag-btn" onclick="window.location.href='/products/${r.productHandle}'">
                    ${icons.bag} View Product
                  </button>
                </div>
            </div>

            <div class="bottom-shopper-info" style="background-color: ${s.cardBackgroundColor};">
              ${s.showProductDetails ? `
              <div class="product-flex-row">
                <div class="prod-thumbnail"><img src="${r.productImage || ''}" alt="product"></div>
                <div class="prod-details-meta">
                  <p class="p-title-exact" style="color: ${s.productTitleColor}; font-size: calc(${s.productTextSize}px * var(--rc-text-scale));">
                    ${r.productTitle || 'Product Name'}
                  </p>
                  <div class="p-price-line">
                    <span class="p-current" style="color: ${s.productPriceColor}; font-size: calc(${s.productTextSize}px * var(--rc-text-scale));">
                        Rs. ${priceValue > 0 ? priceValue : 'N/A'}
                    </span>
                    <span class="p-save-badge">Save ${discount}%</span>
                  </div>
                </div>
                <div class="p-like-circle" id="like-btn-${r.id}" onclick="toggleLike('${r.id}')" style="color: ${s.productTitleColor}; border-color: ${s.productPriceColor}; opacity: 0.6;">
                    ${icons.heartOutline}
                </div>
              </div>
              ` : ''}

              <button class="exact-checkout-btn ${s.buttonAnimation}" 
                      style="background-color: ${s.primaryColor}; color: ${s.buttonTextColor}; font-size: calc(13px * var(--rc-text-scale));" 
                      onclick="addToCartNow('${r.variantId}', event)">
                ${s.buttonText}
              </button>
            </div>
          </div>`;
      }).join('');

    } catch (e) { console.error(e); }
  }

  function handleHoverPlay(vid, play) {
      const v = document.getElementById(vid);
      if(v) play ? v.play().catch(()=>{}) : v.pause();
  }

  function toggleMute(id) {
      const v = document.getElementById(`video-${id}`);
      const btn = document.getElementById(`mute-btn-${id}`);
      if(v && btn) {
          v.muted = !v.muted;
          btn.innerHTML = v.muted ? icons.mute : icons.unmute;
      }
  }

  // üî• Track View (Increments Real View Count)
  async function trackView(reelId) {
    // Only track once per session logic can be added here if needed
    fetch('/apps/reel-data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reelId: parseInt(reelId), intent: 'increment_views' })
    }).catch(e => {});
  }

  // üî• Toggle Like (Updates DB & UI)
  async function toggleLike(id) {
    const btn = document.getElementById(`like-btn-${id}`);
    const isLiked = btn.innerHTML.includes('fill="#ff4d4d"');
    
    // Optimistic UI Update
    btn.innerHTML = isLiked ? icons.heartOutline : icons.heartFilled;
    btn.style.opacity = isLiked ? '0.6' : '1';

    try {
      await fetch('/apps/reel-data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reelId: parseInt(id), intent: 'toggle_like', isLiked: isLiked })
      });
    } catch (e) {
      // Revert if error
      btn.innerHTML = isLiked ? icons.heartFilled : icons.heartOutline;
    }
  }

  function scrollReelList(dir) {
    const el = document.getElementById('reel-app-container');
    const cardWidth = parseInt(getComputedStyle(el).getPropertyValue('--rc-card-width')) || 250;
    el.scrollBy({ left: dir * (cardWidth + 16), behavior: 'smooth' });
  }

  async function addToCartNow(variantId, event) {
    if (!variantId) return;
    const btn = event.currentTarget;
    const oldText = btn.innerText;
    btn.innerText = "...";
    try {
        await fetch(window.Shopify.routes.root + 'cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: [{ id: variantId, quantity: 1 }] })
        });
        window.location.href = '/checkout'; 
    } catch(e) {
        btn.innerText = oldText;
    }
  }

  document.addEventListener('DOMContentLoaded', loadStoreReels);
</script>

<style>
  .reelcart-main-container { max-width: 1400px; margin: 0 auto; box-sizing: border-box; }
  .reel-header-area { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; }
  .reel-title-text { font-size: 24px; font-weight: 700; margin: 0; }
  .reel-navigation { display: flex; gap: 8px; }
  .reel-nav-btn { background: rgba(0,0,0,0.05); border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: 0.2s; }
  .reel-nav-btn:hover { background: rgba(0,0,0,0.1); }

  .reel-pro-scroller { display: flex; overflow-x: auto; padding-bottom: 20px; scroll-snap-type: x mandatory; scrollbar-width: none; align-items: start; }
  .reel-pro-scroller::-webkit-scrollbar { display: none; }
  .reel-pro-scroller.grid-mode { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(var(--rc-card-width, 250px), 1fr));
      overflow: visible; 
      padding-bottom: 0; 
  }

  /* CARD */
  .reel-exact-card { 
      position: relative; 
      width: var(--rc-card-width, 250px);
      min-width: var(--rc-card-width, 250px);
      display: flex; 
      flex-direction: column; 
      overflow: hidden; 
      flex-shrink: 0; 
      scroll-snap-align: start; 
      transition: transform 0.2s ease; 
      border: 1px solid #eee; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      height: auto; 
  }
  .grid-mode .reel-exact-card { width: 100%; min-width: 0; }

  /* VIDEO PART */
  .video-container-box { position: relative; width: 100%; background: #000; overflow: hidden; }
  .video-container-box.aspect-portrait { aspect-ratio: 9 / 16; }
  .video-container-box.aspect-square { aspect-ratio: 1 / 1; }

  .reel-video-element { width: 100%; height: 100%; object-fit: cover; display: block; }
  .reel-gradient-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.4) 30%, transparent 60%); pointer-events: none; opacity: 0; }
  
  .reel-ui-layer { position: absolute; inset: 0; padding: 10px; display: flex; flex-direction: column; justify-content: space-between; pointer-events: none; z-index: 2; }
  .reel-ui-layer * { pointer-events: auto; }

  .top-stats-row { display: flex; gap: 6px; }
  .stat-pill { background: rgba(0,0,0,0.6); color: #fff; font-size: var(--rc-badge-font-size, 10px); padding: 4px 8px; border-radius: 20px; backdrop-filter: blur(8px); }
  
  .mute-btn-overlay { position: absolute; right: 10px; top: 10px; background: rgba(0,0,0,0.6); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(8px); }
  .view-tag-btn { background: rgba(255,255,255,0.25); color: white; border: 1px solid rgba(255,255,255,0.5); font-size: var(--rc-badge-font-size, 11px); padding: 6px 12px; border-radius: 20px; width: fit-content; display: flex; align-items: center; gap: 6px; cursor: pointer; backdrop-filter: blur(10px); margin-bottom: 0; margin-top: auto; }

  /* INFO PART */
  .bottom-shopper-info { padding: 12px; display: flex; flex-direction: column; gap: 10px; flex: 1; justify-content: space-between; border-top: 1px solid rgba(0,0,0,0.05); }
  .product-flex-row { display: flex; align-items: center; gap: 10px; }
  .prod-thumbnail img { width: calc(40px * var(--rc-text-scale, 1)); height: calc(40px * var(--rc-text-scale, 1)); border-radius: 6px; object-fit: cover; border: 1px solid rgba(0,0,0,0.1); }
  .prod-details-meta { flex: 1; overflow: hidden; }
  .p-title-exact { margin: 0 0 3px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; line-height: 1.2; }
  .p-price-line { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
  .p-current { font-weight: 700; }
  .p-save-badge { background: #ff4d4d; color: white; font-size: var(--rc-badge-font-size, 9px); padding: 2px 5px; border-radius: 3px; font-weight: 700; line-height: 1; }
  .p-like-circle { width: 30px; height: 30px; border: 1px solid rgba(0,0,0,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
  .exact-checkout-btn { width: 100%; border: none; padding: 10px; border-radius: 6px; font-weight: 700; font-size: 13px; cursor: pointer; text-align: center; transition: opacity 0.2s; }
  
  @media (max-width: 768px) {
    .reel-exact-card { width: max(160px, var(--rc-card-width)); min-width: 160px; }
    .grid-mode { grid-template-columns: repeat(2, 1fr) !important; gap: 10px !important; }
    .view-tag-btn { display: none; }
  }
</style>

{% schema %}
{ "name": "ReelCart ‚Äì Branded UI", "target": "section", "settings": [ { "type": "text", "id": "heading", "label": "Heading", "default": "Shop the Look" } ] }
{% endschema %}